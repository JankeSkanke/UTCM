name: Publish to PowerShell Gallery

on:
  release:
    types: [published]

jobs:
  validate-and-test:
    name: Validate & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.0 -Force -Scope CurrentUser
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Settings PSGallery -ExcludeRule PSUseShouldProcessForStateChangingFunctions
          if ($results | Where-Object Severity -eq 'Error') {
            $results | Format-Table -AutoSize
            Write-Error "PSScriptAnalyzer found errors — aborting publish"
            exit 1
          }

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path ./UTCM.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"

      - name: Run Pester Tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './Tests'
          $config.Output.Verbosity = 'Detailed'
          $result = Invoke-Pester -Configuration $config

          if ($result.FailedCount -gt 0) {
            Write-Error "$($result.FailedCount) test(s) failed — aborting publish"
            exit 1
          }

  publish:
    name: Publish Module
    runs-on: ubuntu-latest
    needs: validate-and-test
    environment: PSGallery

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Version Matches Tag
        shell: pwsh
        run: |
          $tag = "${{ github.event.release.tag_name }}" -replace '^v', ''
          $manifest = Test-ModuleManifest -Path ./UTCM.psd1
          $moduleVersion = $manifest.Version.ToString()

          if ($moduleVersion -ne $tag) {
            Write-Error "Version mismatch: manifest says '$moduleVersion' but release tag is '$tag'"
            exit 1
          }

          Write-Host "Version match confirmed: $moduleVersion"

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          # Stage the module files into a clean publish directory
          $publishDir = Join-Path $env:RUNNER_TEMP 'UTCM'
          New-Item -Path $publishDir -ItemType Directory -Force | Out-Null

          # Copy only module files (not tests, docs, examples, etc.)
          $items = @(
            'UTCM.psd1'
            'UTCM.psm1'
            'UTCM.Format.ps1xml'
            'Public'
            'Private'
            'LICENSE'
            'CHANGELOG.md'
            'README.md'
          )

          foreach ($item in $items) {
            Copy-Item -Path $item -Destination $publishDir -Recurse -Force
          }

          Write-Host "Publishing UTCM to PowerShell Gallery..."
          Publish-Module -Path $publishDir -NuGetApiKey $env:NUGET_API_KEY -Verbose
          Write-Host "Published successfully!"
